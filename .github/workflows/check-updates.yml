name: Check OpenClaw Updates

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check latest OpenClaw release
        id: check
        run: |
          LATEST=$(curl -s https://api.github.com/repos/openclaw/openclaw/releases/latest | jq -r .tag_name)
          CURRENT=$(grep "OPENCLAW_GIT_REF" Dockerfile | grep -oP '(?<=OPENCLAW_GIT_REF=)[^ ]+' | tr -d '"')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          if [ "$LATEST" != "$CURRENT" ] && [ "$CURRENT" != "main" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create update PR
        if: steps.check.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update OpenClaw to ${{ steps.check.outputs.latest }}"
          title: "Update OpenClaw ${{ steps.check.outputs.current }} → ${{ steps.check.outputs.latest }}"
          body: |
            A new OpenClaw release is available.
            
            **Changes:** ${{ steps.check.outputs.current }} → ${{ steps.check.outputs.latest }}
            
            [View release notes](https://github.com/openclaw/openclaw/releases/tag/${{ steps.check.outputs.latest }})
            
            Auto-generated by OpenClaw update checker.
          branch: update-openclaw-${{ steps.check.outputs.latest }}
          delete-branch: true
